---
- block:
  - name: Download OnlyOffice's auto-install script of Ubuntu&Debian
    get_url:
      url: "{{onlyoffice_debian_download}}"
      dest: /tmp/
      mode: 0755
    
  - name: install script
    command: /tmp/install-Debian.sh -os true

  when: ansible_os_family == 'Debian'


- block:
  - name: Download OnlyOffice's auto-install script of Redhat&CentOS
    get_url:
      url: "{{onlyoffice_redhat_download}}"
      dest: /tmp/
      mode: 0755
    
  - name: install script
    command: /tmp/install-RedHat.sh -os true 

  when: ansible_os_family == 'RedHat'

# 处理数据库随机密码问题

#添加 onlyoffice 数据库用户，授权，更改 /var/www/onlyoffice/WebStudio/web.connections.config 文件中的数据库配置信息
- name: get default root password of mysql
  shell: grep "Password" /var/www/onlyoffice/WebStudio/web.connections.config | awk -F\; '{print $4}' | awk -F'=' '{print $2}'
  register: root_password

- name: create mysql user "onlyoffice"
  mysql_user:
    name: onlyoffice
    password: "{{root_password.stdout}}"
    login_user: root
    login_password: "{{root_password.stdout}}"
    priv: 'onlyoffice.*:ALL'
    
- name: replace user id in web.connections.config
  replace:
    path: /var/www/onlyoffice/WebStudio/web.connections.config
    before: ';Password'
    after: 'User ID='
    regexp: 'root'
    replace: 'onlyoffice'

- name: restart mysql monoserve monoserveApiSystem
  service:
    name: mysql 
    state: restarted
    enabled: yes

- name: restart monoserve
  service:
    name: monoserve.service
    state: restarted
    enabled: yes

- name: restart monoserveApiSystem.service
  service: name=monoserveApiSystem.service  state=restarted

- name: Delete script
  file:
    path: /tmp/opensource-install.sh
    state: absent